{
  "InstanceIds": ["i-0fba58db502cc8d39"],
  "DocumentName": "AWS-RunShellScript",
  "Parameters": {
    "commands": [
      "cd /var/www/summit/server",
      "echo '=== Step 1: Stopping everything ==='",
      "pm2 stop all",
      "pm2 delete all",
      "sleep 2",
      "echo '=== Step 2: Clearing port 3000 ==='",
      "lsof -ti:3000 | xargs kill -9 2>/dev/null || echo 'Port 3000 cleared'",
      "sleep 2",
      "echo '=== Step 3: Checking .env file ==='",
      "echo 'Checking SUPABASE_URL:'",
      "grep SUPABASE_URL .env || echo 'MISSING: SUPABASE_URL'",
      "echo 'Checking SUPABASE_SERVICE_ROLE_KEY:'",
      "grep SUPABASE_SERVICE_ROLE_KEY .env | sed 's/SUPABASE_SERVICE_ROLE_KEY=.*/SUPABASE_SERVICE_ROLE_KEY=***HIDDEN***/' || echo 'MISSING: SUPABASE_SERVICE_ROLE_KEY'",
      "echo ''",
      "echo '=== Step 4: Pulling latest code ==='",
      "git pull origin main",
      "echo ''",
      "echo '=== Step 5: Rebuilding ==='",
      "npm run build",
      "echo ''",
      "echo '=== Step 6: Starting backend ==='",
      "pm2 start dist/index.js --name summit-backend --update-env",
      "sleep 5",
      "echo ''",
      "echo '=== Step 7: PM2 Status ==='",
      "pm2 list",
      "echo ''",
      "echo '=== Step 8: Testing health ==='",
      "curl -s http://localhost:3000/health || echo 'Health check FAILED'",
      "echo ''",
      "echo '=== Step 9: Recent logs ==='",
      "pm2 logs summit-backend --lines 10 --nostream 2>&1 | tail -10"
    ]
  }
}

