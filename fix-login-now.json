{
  "InstanceIds": ["i-0fba58db502cc8d39"],
  "DocumentName": "AWS-RunShellScript",
  "Parameters": {
    "commands": [
      "cd /var/www/summit/server",
      "echo '=== FIXING LOGIN - STEP 1: Stopping everything ==='",
      "pm2 stop all 2>/dev/null || true",
      "pm2 delete all 2>/dev/null || true",
      "sleep 2",
      "echo '=== STEP 2: Clearing port 3000 ==='",
      "lsof -ti:3000 | xargs kill -9 2>/dev/null || echo 'Port cleared'",
      "sleep 2",
      "echo '=== STEP 3: Checking Supabase credentials ==='",
      "if ! grep -q 'SUPABASE_URL' .env; then",
      "  echo 'Adding SUPABASE_URL to .env...'",
      "  echo 'SUPABASE_URL=https://rzxhbqwzpucqwxngkxbr.supabase.co' >> .env",
      "fi",
      "if ! grep -q 'SUPABASE_SERVICE_ROLE_KEY' .env; then",
      "  echo 'Adding SUPABASE_SERVICE_ROLE_KEY to .env...'",
      "  echo 'SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6eGhicXd6cHVjcXd4bmdreGJyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODEzMjA0MCwiZXhwIjoyMDgzNzA4MDQwfQ.OCR0dpSg1h4cfxZCZFMXFm_5fhr5i6N_DzEhOQccJHo' >> .env",
      "fi",
      "echo '=== STEP 4: Pulling latest code ==='",
      "git pull origin main",
      "echo '=== STEP 5: Installing dependencies ==='",
      "npm install",
      "echo '=== STEP 6: Rebuilding ==='",
      "npm run build",
      "echo '=== STEP 7: Starting backend ==='",
      "pm2 start dist/index.js --name summit-backend --update-env",
      "sleep 10",
      "echo '=== STEP 8: PM2 Status ==='",
      "pm2 list",
      "echo ''",
      "echo '=== STEP 9: Testing health ==='",
      "curl -s http://localhost:3000/health && echo ' - HEALTH OK' || echo ' - HEALTH FAILED'",
      "echo ''",
      "echo '=== STEP 10: Recent logs ==='",
      "pm2 logs summit-backend --lines 5 --nostream 2>&1 | tail -5"
    ]
  }
}

