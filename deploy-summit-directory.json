{
  "commands": [
    "#!/bin/bash",
    "set -e",
    "echo '=== Deploying Summit Backend from GitHub ==='",
    "cd /tmp",
    "rm -rf summit",
    "git clone https://github.com/Icokruger999/summit.git",
    "cd summit/backend",
    "echo 'Creating deployment directory...'",
    "sudo mkdir -p /var/www/summit",
    "echo 'Copying files...'",
    "sudo cp -r * /var/www/summit/ 2>/dev/null || true",
    "if [ -d dist ]; then sudo cp -r dist /var/www/summit/; fi",
    "if [ -f package.json ]; then sudo cp package.json package-lock.json /var/www/summit/; fi",
    "cd /var/www/summit",
    "echo 'Creating .env file...'",
    "if [ ! -f .env ]; then",
    "  JWT_SECRET=$(openssl rand -base64 32)",
    "  cat > .env <<EOF",
    "PORT=4000",
    "NODE_ENV=production",
    "DB_HOST=codingeverest-new.cl4qcomc6fj0.eu-west-1.rds.amazonaws.com",
    "DB_PORT=5432",
    "DB_NAME=Summit",
    "DB_USER=postgres",
    "DB_PASSWORD=Stacey1122",
    "JWT_SECRET=$JWT_SECRET",
    "CORS_ORIGIN=https://summit.codingeverest.com,https://www.codingeverest.com",
    "LIVEKIT_API_KEY=devkey",
    "LIVEKIT_API_SECRET=devsecret",
    "LIVEKIT_URL=wss://livekit.codingeverest.com",
    "MAX_FILE_SIZE=10485760",
    "UPLOAD_PATH=/var/www/summit/uploads",
    "EOF",
    "fi",
    "echo 'Installing dependencies...'",
    "sudo npm install --production --legacy-peer-deps",
    "echo 'Creating uploads directory...'",
    "sudo mkdir -p uploads",
    "echo 'Stopping existing backend...'",
    "sudo pm2 stop summit-backend || true",
    "sudo pm2 delete summit-backend || true",
    "echo 'Starting backend...'",
    "sudo pm2 start dist/index.js --name summit-backend",
    "sudo pm2 save",
    "echo 'Waiting for startup...'",
    "sleep 3",
    "echo 'Testing backend...'",
    "curl -f http://localhost:4000/health && echo '' && echo '✅ Backend is running!' || echo '❌ Health check failed'",
    "echo ''",
    "echo 'PM2 Status:'",
    "sudo pm2 list"
  ]
}

