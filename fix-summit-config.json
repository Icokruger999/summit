{
  "description": "Fix Summit backend configuration - Update .env to use local PgBouncer",
  "schemaVersion": "2.2",
  "parameters": {},
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "fixSummitConfig",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "",
          "echo '=== Fixing Summit Backend Configuration ==='",
          "echo ''",
          "",
          "# Find server directory",
          "if [ -d '/var/www/summit/server' ]; then",
          "    cd /var/www/summit/server",
          "elif [ -d '/opt/summit/server' ]; then",
          "    cd /opt/summit/server",
          "elif [ -d '~/summit/server' ]; then",
          "    cd ~/summit/server",
          "else",
          "    echo 'âŒ Could not find server directory'",
          "    exit 1",
          "fi",
          "",
          "SERVER_DIR=$(pwd)",
          "echo \"âœ… Found server directory: $SERVER_DIR\"",
          "echo ''",
          "",
          "# Backup existing .env",
          "if [ -f .env ]; then",
          "    echo 'ðŸ“¦ Backing up existing .env'",
          "    cp .env .env.backup.$(date +%Y%m%d_%H%M%S)",
          "fi",
          "",
          "# Get existing password if available",
          "if [ -f .env ] && grep -q '^DB_PASSWORD=' .env; then",
          "    DB_PASSWORD=$(grep '^DB_PASSWORD=' .env | cut -d'=' -f2)",
          "    echo 'âœ… Using existing password from .env'",
          "else",
          "    echo 'âš ï¸  No password found in .env'",
          "    echo 'Please run with password parameter or update manually'",
          "    DB_PASSWORD='CHANGE_ME'",
          "fi",
          "",
          "# Create new .env file",
          "echo 'ðŸ“ Creating new .env file...'",
          "cat > .env << 'ENVEOF'",
          "# Server Configuration",
          "PORT=3000",
          "HOST=0.0.0.0",
          "NODE_ENV=production",
          "",
          "# Database Configuration (PgBouncer on EC2 - LOCAL)",
          "DB_HOST=127.0.0.1",
          "DB_PORT=6432",
          "DB_NAME=summit",
          "DB_USER=summit_user",
          "DB_PASSWORD=${DB_PASSWORD}",
          "",
          "# JWT Secret (CHANGE THIS)",
          "JWT_SECRET=CHANGE_ME_TO_SECURE_RANDOM_STRING",
          "",
          "# CORS Configuration",
          "CORS_ORIGIN=https://summit.codingeverest.com,https://www.codingeverest.com",
          "",
          "# LiveKit Configuration",
          "LIVEKIT_API_KEY=devkey",
          "LIVEKIT_API_SECRET=secret",
          "LIVEKIT_URL=ws://localhost:7880",
          "ENVEOF",
          "",
          "# Replace password placeholder",
          "sed -i \"s|\\${DB_PASSWORD}|$DB_PASSWORD|g\" .env",
          "",
          "echo 'âœ… .env file created'",
          "echo ''",
          "",
          "# Show configuration (without password)",
          "echo '=== Configuration ==='",
          "grep -E '^(DB_HOST|DB_PORT|DB_NAME|DB_USER|CORS_ORIGIN|PORT)=' .env",
          "echo ''",
          "",
          "# Test database connection",
          "echo '=== Testing Database Connection ==='",
          "if command -v psql &> /dev/null; then",
          "    if PGPASSWORD=$DB_PASSWORD psql -h 127.0.0.1 -p 6432 -U summit_user -d summit -c 'SELECT 1;' &> /dev/null; then",
          "        echo 'âœ… Database connection successful'",
          "    else",
          "        echo 'âŒ Database connection failed'",
          "        sudo systemctl status pgbouncer --no-pager | head -5",
          "    fi",
          "fi",
          "echo ''",
          "",
          "# Rebuild",
          "echo '=== Rebuilding Server ==='",
          "npm install --production",
          "npm run build",
          "echo 'âœ… Build complete'",
          "echo ''",
          "",
          "# Restart PM2",
          "echo '=== Restarting PM2 ==='",
          "pm2 stop summit-backend 2>/dev/null || true",
          "pm2 delete summit-backend 2>/dev/null || true",
          "pm2 start ecosystem.config.cjs --env production",
          "pm2 save",
          "echo 'âœ… PM2 restarted'",
          "echo ''",
          "",
          "# Show status",
          "pm2 status",
          "echo ''",
          "",
          "# Test health",
          "sleep 3",
          "echo '=== Testing Health Endpoint ==='",
          "curl -s http://localhost:3000/health",
          "echo ''",
          "echo ''",
          "",
          "echo '=== Configuration Fix Complete ==='",
          "echo 'Test at: https://summit.codingeverest.com'"
        ]
      }
    }
  ]
}
