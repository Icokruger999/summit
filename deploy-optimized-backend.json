{
  "commands": [
    "#!/bin/bash",
    "set -e",
    "cd /tmp",
    "rm -rf summit",
    "git clone https://github.com/Icokruger999/summit.git",
    "cd summit/backend",
    "mkdir -p /var/www/summit",
    "cp package.json package-lock.json /var/www/summit/",
    "if [ -f .env.production ]; then cp .env.production /var/www/summit/; elif [ -f env-template.txt ]; then cp env-template.txt /var/www/summit/.env.production; fi",
    "cd /var/www/summit",
    "npm install --production --legacy-peer-deps",
    "if [ -d /tmp/summit/backend/dist ]; then cp -r /tmp/summit/backend/dist /var/www/summit/; else cd /tmp/summit/backend && npm install && npm run build && cp -r dist /var/www/summit/; fi",
    "cd /var/www/summit",
    "if [ ! -f .env ]; then JWT_SECRET=$(openssl rand -base64 32) && sed \"s/CHANGE_ON_DEPLOYMENT/$JWT_SECRET/\" .env.production > .env || echo 'PORT=4000\\nNODE_ENV=production\\nDB_HOST=codingeverest-new.cl4qcomc6fj0.eu-west-1.rds.amazonaws.com\\nDB_PORT=5432\\nDB_NAME=Summit\\nDB_USER=postgres\\nDB_PASSWORD=Stacey1122\\nJWT_SECRET='$JWT_SECRET'\\nCORS_ORIGIN=https://summit.codingeverest.com,https://www.codingeverest.com\\nLIVEKIT_API_KEY=devkey\\nLIVEKIT_API_SECRET=devsecret' > .env; fi",
    "pm2 stop summit-backend || true",
    "pm2 delete summit-backend || true",
    "pm2 start dist/index.js --name summit-backend",
    "pm2 save",
    "sleep 3",
    "curl http://localhost:4000/health || echo 'Health check failed'"
  ]
}

