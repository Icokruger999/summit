{
  "InstanceIds": ["i-0fba58db502cc8d39"],
  "DocumentName": "AWS-RunShellScript",
  "Parameters": {
    "commands": [
      "cat > /var/www/summit/health-check-fix.sh << 'HEALTHEOF'",
      "#!/bin/bash",
      "DEPLOY_PATH=\"/var/www/summit/server\"",
      "LOCAL_URL=\"http://localhost:3000/health\"",
      "LOG_FILE=\"/var/log/summit-health-check.log\"",
      "log() { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\" | tee -a \"$LOG_FILE\"; }",
      "check_backend() { curl -s -f \"$LOCAL_URL\" > /dev/null 2>&1 && return 0 || return 1; }",
      "check_pm2() { cd \"$DEPLOY_PATH\" && pm2 list | grep -q \"summit-backend.*online\" && return 0 || return 1; }",
      "start_backend() {",
      "  log \"Starting backend...\"",
      "  cd \"$DEPLOY_PATH\" || return 1",
      "  pm2 stop summit-backend 2>/dev/null",
      "  pm2 delete summit-backend 2>/dev/null",
      "  if [ -f ecosystem.config.js ]; then",
      "    pm2 start ecosystem.config.js --env production",
      "  else",
      "    pm2 start dist/index.js --name summit-backend",
      "  fi",
      "  pm2 save",
      "  sleep 10",
      "  pm2 list | grep -q \"summit-backend.*online\" && log \"Backend started\" || log \"Backend failed\"",
      "}",
      "main() {",
      "  log \"=== Health Check ===\"",
      "  if check_backend; then",
      "    log \"✅ Backend responding\"",
      "    check_pm2 || start_backend",
      "    exit 0",
      "  else",
      "    log \"❌ Backend NOT responding\"",
      "    check_pm2 || start_backend",
      "    pm2 restart summit-backend 2>/dev/null",
      "    sleep 10",
      "    check_backend && log \"✅ Fixed\" || log \"❌ Still down\"",
      "  fi",
      "}",
      "main",
      "HEALTHEOF",
      "chmod +x /var/www/summit/health-check-fix.sh",
      "crontab -l 2>/dev/null | grep -v summit-health || true",
      "echo '*/5 * * * * /var/www/summit/health-check-fix.sh >> /var/log/summit-health-check.log 2>&1' | crontab -",
      "crontab -l | grep summit",
      "/var/www/summit/health-check-fix.sh"
    ]
  }
}

