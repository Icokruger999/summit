=================================================================
MANUAL SSM DEPLOYMENT COMMANDS FOR INSTANCE i-06bc5b2218c041802
=================================================================

STEP 1: Go to AWS Console
--------------------------
1. Open: https://console.aws.amazon.com/systems-manager/session-manager
2. Click "Start session"
3. Select instance: i-06bc5b2218c041802  
4. Click "Start session"

STEP 2: In the SSM Session Terminal, run these commands:
--------------------------------------------------------

# Setup directory
sudo mkdir -p /opt/summit-backend
sudo chown ubuntu:ubuntu /opt/summit-backend
cd /opt/summit-backend

# Download your code (Option A: if you uploaded to S3)
# aws s3 cp s3://codingeverest-deployments/summit/server.zip server.zip

# OR Option B: Create a temporary file with base64 content
# (I'll generate this for you below)

# Install Node.js if not installed
node --version || (curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs)

# Install dependencies
npm install --production

# Build
npm run build

# Create .env file
cat > .env << 'EOF'
PORT=3001
DB_HOST=codingeverest-new.cl4qcomc6fj0.eu-west-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=Summit
DB_USER=postgres
DB_PASSWORD=Stacey1122
JWT_SECRET=summit-secret-change-this-in-production
EOF

# Install PM2
sudo npm install -g pm2

# Stop existing if running  
pm2 stop summit-backend 2>/dev/null || true
pm2 delete summit-backend 2>/dev/null || true

# Start on port 3001 (isolated from your 5000, 50001)
pm2 start dist/index.js --name summit-backend
pm2 save
pm2 startup
pm2 status

echo "================================"
echo "Backend running on port 3001"
echo "================================"


STEP 3: Setup Database
-----------------------
# Install PostgreSQL client
sudo apt-get update
sudo apt-get install -y postgresql-client

# Create Summit database
PGPASSWORD='Stacey1122' psql -h codingeverest-new.cl4qcomc6fj0.eu-west-1.rds.amazonaws.com -U postgres -d postgres -c "CREATE DATABASE \"Summit\";" 2>/dev/null || echo "Database may already exist"

# Create schema file
cat > /tmp/schema.sql << 'SCHEMA'
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT NOT NULL UNIQUE,
  name TEXT,
  avatar_url TEXT,
  password_hash TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS meetings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  description TEXT,
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,
  room_id TEXT NOT NULL UNIQUE,
  created_by UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  recurrence JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS meeting_participants (
  meeting_id UUID REFERENCES meetings(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (meeting_id, user_id)
);

CREATE TABLE IF NOT EXISTS meeting_invitations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  meeting_id UUID REFERENCES meetings(id) ON DELETE CASCADE NOT NULL,
  inviter_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  invitee_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(meeting_id, invitee_id)
);

CREATE TABLE IF NOT EXISTS attachments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type TEXT,
  chat_id TEXT,
  meeting_id UUID REFERENCES meetings(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_meetings_created_by ON meetings(created_by);
SCHEMA

# Run schema
PGPASSWORD='Stacey1122' psql -h codingeverest-new.cl4qcomc6fj0.eu-west-1.rds.amazonaws.com -U postgres -d Summit -f /tmp/schema.sql

echo "Database setup complete!"


STEP 4: Open Security Group Port 3001
--------------------------------------
1. Go to: https://console.aws.amazon.com/ec2/
2. Find instance: i-06bc5b2218c041802
3. Click on Security Group
4. Edit inbound rules
5. Add rule:
   - Type: Custom TCP
   - Port: 3001
   - Source: 0.0.0.0/0
   - Description: Summit Backend API
6. Save


STEP 5: Get EC2 Public IP and Test
-----------------------------------
1. In EC2 console, copy Public IPv4 address of i-06bc5b2218c041802
2. Test: curl http://YOUR-EC2-IP:3001/health
3. Should return: {"status":"ok"}


STEP 6: Configure Desktop App
------------------------------
Create file: C:\CodingE-Chat\desktop\.env

VITE_SERVER_URL=http://YOUR-EC2-PUBLIC-IP:3001
VITE_SUPABASE_URL=
VITE_SUPABASE_ANON_KEY=
VITE_LIVEKIT_URL=ws://YOUR-EC2-PUBLIC-IP:7880


STEP 7: Run Desktop App
------------------------
cd C:\CodingE-Chat\desktop
npm run tauri:dev


ISOLATION CONFIRMED:
--------------------
✓ Port: 3001 (no conflict with 5000, 50001)
✓ Directory: /opt/summit-backend
✓ Process: summit-backend (PM2)
✓ Database: Summit (separate)

Your existing applications are safe!
=================================================================

